
import * as ethers from "ethers"
import { AbiItem } from 'web3-utils';
import { Contract } from 'web3-eth-contract';
import { Web3Manager } from './Web3Manager';
import { calculateCreate2Addr } from "../utils/CreateAddr";

const DEPLOYMENT_MANAGER_ABI: AbiItem[] = [{"inputs":[{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"call","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"},{"internalType":"uint128","name":"callNonce","type":"uint128"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"callFor","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"minver","type":"uint256"}],"name":"checkVersion","outputs":[],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"bytes","name":"bytecode","type":"bytes"}],"name":"create","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"uint256","name":"salt","type":"uint256"},{"internalType":"bytes","name":"bytecode","type":"bytes"}],"name":"create2","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"uint256","name":"salt","type":"uint256"},{"internalType":"bytes","name":"bytecode","type":"bytes"},{"internalType":"uint128","name":"callNonce","type":"uint128"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"create2For","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"}],"name":"createDeployer","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"bytes","name":"bytecode","type":"bytes"},{"internalType":"uint128","name":"callNonce","type":"uint128"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"createFor","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"address","name":"addr","type":"address"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"delegate","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"address","name":"addr","type":"address"},{"internalType":"bytes","name":"data","type":"bytes"},{"internalType":"uint128","name":"callNonce","type":"uint128"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"delegateFor","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"},{"internalType":"uint128","name":"nonce","type":"uint128"}],"name":"getCallHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"uint256","name":"salt","type":"uint256"},{"internalType":"bytes","name":"bytecode","type":"bytes"}],"name":"getCreate2Address","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"uint256","name":"salt","type":"uint256"},{"internalType":"bytes","name":"bytecode","type":"bytes"},{"internalType":"uint128","name":"nonce","type":"uint128"}],"name":"getCreate2Hash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"uint256","name":"nonce","type":"uint256"}],"name":"getCreateAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"bytes","name":"bytecode","type":"bytes"},{"internalType":"uint128","name":"nonce","type":"uint128"}],"name":"getCreateHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"address","name":"addr","type":"address"},{"internalType":"bytes","name":"data","type":"bytes"},{"internalType":"uint128","name":"nonce","type":"uint128"}],"name":"getDelegateHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"}],"name":"getDeployer","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"}],"name":"getDeployerAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getDeploymentAccountImplementation","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"pure","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"uint16","name":"count","type":"uint16"},{"internalType":"uint128","name":"nonce","type":"uint128"}],"name":"getNopHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"uint16","name":"count","type":"uint16"}],"name":"nop","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"account_salt","type":"uint256"},{"internalType":"uint16","name":"count","type":"uint16"},{"internalType":"uint128","name":"callNonce","type":"uint128"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"nopFor","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"version","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"pure","type":"function"}];
const DEPLOYMENT_ACCOUNT_CODE: string = "608060405234801561001057600080fd5b506040516102d23803806102d283398101604081905261002f91610070565b600080546001600160a01b039092166001600160a01b03199283161790556001805490911633178155600280546001600160801b03191690911790556100a0565b60006020828403121561008257600080fd5b81516001600160a01b038116811461009957600080fd5b9392505050565b610223806100af6000396000f3fe6080604052600436106100385760003560e01c80635c60da1b1461004f578063b2bdfa7b14610080578063f0329f6b146100a057610047565b36610047576100456100c0565b005b6100456100c0565b34801561005b57600080fd5b50610064610126565b6040516001600160a01b03909116815260200160405180910390f35b34801561008c57600080fd5b50600054610064906001600160a01b031681565b3480156100ac57600080fd5b50600154610064906001600160a01b031681565b60006100ca610126565b90506001600160a01b03811661011a5760405162461bcd60e51b815260206004820152601160248201527037379034b6b83632b6b2b73a30ba34b7b760791b604482015260640160405180910390fd5b61012381610199565b50565b6001546040805163594420fb60e01b815290516000926001600160a01b03169163594420fb9160048083019260209291908290030181865afa158015610170573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061019491906101bd565b905090565b3660008037600080366000845af43d6000803e8080156101b8573d6000f35b3d6000fd5b6000602082840312156101cf57600080fd5b81516001600160a01b03811681146101e657600080fd5b939250505056fea2646970667358221220ddd011277af191480f5b5fc191917f03daafd7eac98ed338d9b5ef66b1381fb264736f6c63430008110033";
const DEPLOYMENT_ACCOUNT_ABI: AbiItem[] = [{"inputs":[],"name":"_manager","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"_owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"call","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"callNonce","outputs":[{"internalType":"uint128","name":"","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"bytes","name":"bytecode","type":"bytes"}],"name":"create","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"salt","type":"uint256"},{"internalType":"bytes","name":"bytecode","type":"bytes"}],"name":"create2","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"delegate","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"nonce","outputs":[{"internalType":"uint128","name":"","type":"uint128"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint16","name":"count","type":"uint16"}],"name":"nop","outputs":[],"stateMutability":"nonpayable","type":"function"}];

export class ContractInterface {
  public static getDeploymentManager(addr: string): Contract {
    return Web3Manager.instance.getContractInterface(DEPLOYMENT_MANAGER_ABI, addr);
  }

  public static getDeploymentAccount(addr: string): Contract {
    return Web3Manager.instance.getContractInterface(DEPLOYMENT_ACCOUNT_ABI, addr);
  }

  public static getDeploymentAccountAddress(manager: string, owner: string, salt: number): string {
    let deployerKey = ethers.keccak256(ethers.solidityPacked(
      ["address", "uint"], 
      [owner, salt]
    ));
    let constructor = "000000000000000000000000" + owner.replace(/^0x/, "").toLowerCase();
    return calculateCreate2Addr(manager, deployerKey, DEPLOYMENT_ACCOUNT_CODE + constructor);
  }
}
